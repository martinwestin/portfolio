{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block head %}
    <style>
        * {
            color: #35979e;
            font-family: Arial, Helvetica, sans-serif;
        }

        .main-container {
            width: 95vw;
            background-color: rgb(115, 255, 201);
            margin: auto;
            border-radius: 10px;
            overflow: auto;
            margin-top: 3vw;
            height: 45vw;
            padding: 1vw;
            display: flex;
        }

        .title-container {
            background-color: aliceblue;
            border-radius: 10px;
            width: 15vw;
            height: 4vw;
            padding: 0.125vw;
            overflow: auto;
        }

        .profile-picture-container {
            margin-left: 1vw;
            background-color: aliceblue;
            height: 10vw;
            padding: 1vw;
            border-radius: 10px;
            width: 12vw;
            overflow: auto;
        }

        button {
            border-radius: 5px;
            background-color: aliceblue;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 3px solid #35979e;
            text-align: left;
            padding: 8px;
            border-radius: 10px;
        }

        tr:nth-child(even) {
            background-color: aliceblue;
        }
        
        .title-container-inner {
            margin-left: 5px;
        }

        .profile-picture-outer {
            border: 3px solid rgb(115, 255, 201);
            border-radius: 10px;
            padding: 5px;
        }

        #profile-picture {
            border: 3px solid rgb(115, 255, 201);
            border-radius: 10px;
        }

        .new-pic-container {
            margin-top: 0.5vw;
            border: 3px solid rgb(115, 255, 201);
            padding: 5px;
            border-radius: 10px;
        }

        .main-content {
            height: 40vw;
            background-color: aliceblue;
            margin-left: 5vw;
            border-radius: 10px;
            width: 100%;
            padding: 1vw;
            overflow: auto;
            display: flex;
        }

        .header {
            padding: 0.5vw;
        }

        .introduction-text-box-container {
            margin-left: 1vw;
        }

        #intro-text-box {
            border-radius: 10px;
            border: 3px solid rgb(115, 255, 201);
        }
        
        .save-button {
            background-color: rgb(115, 255, 201);
            border-radius: 10px;
            height: 1.5vw;
            width: 3vw;
            margin-top: 0.3vw;
            padding: 7px;
        }

        .merits {
            height: 20vw;
            width: 40vw;
            background-color: rgb(115, 255, 201);
            padding: 0.5vw;
            margin-left: 1vw;
            margin-top: 1vw;
            border-radius: 10px;
            overflow: auto;
        }

        .user-merits {
            width: 15vw;
            height: 7vw;
            background-color: aliceblue;
            border-radius: 10px;
            padding: 0.5vw;
            overflow: auto;
        }

        #merits-auto-complete {
            height: 5vw;
            border: 3px solid aliceblue;
            border-radius: 10px;
            margin-top: 0.5vw;
            overflow: auto;
            flex: 1;
            margin-left: 1vw;
            padding: 0.5vw;
        }

        #users-auto-complete {
            border: 3px solid aliceblue;
            border-radius: 10px;
            height: 7vw;
            width: 90%;
            margin-top: 0.5vw;
            overflow: auto;
            padding: 0.5vw;
        }

        .user-result {
            margin-left: 0.5vw;
        }

        .option {
            margin-left: 1vw;
            border: 3px solid aliceblue;
            width: 70%;
            border-radius: 10px;
            padding: 5px;
            display: flex;
        }

        .option-name {
            flex: 1;
        }

        .add-button-container {
            flex: 1;
        }

        .add-button {
            height: 100%;
            width: 100%;
            border-radius: 10px;
        }

        .merits-container {
            margin-left: 1vw;
        }

        .new-merit-container {
            margin-top: 0.5vw;
            margin-left: 0.5vw;
        }

        input {
            border-radius: 5px;
        }

        .main-merits-container {
            display: flex;
        }

        .merit-container-outer {
            display: flex;
        }

        .merit-container {
            border: 3px solid #35979e;
            border-radius: 10px;
            padding: 0.5vw;
            width: 90%;
            overflow: auto;
            display: flex;
        }

        .topic-name-container {
            border: 3px solid #35979e;
            border-radius: 10px;
            padding: 0.25vw;
        }

        .level-container {
            margin-left: 0.5vw;
            border: 3px solid #35979e;
            border-radius: 10px;
            padding: 0.25vw;
        }

        .change-level-container {
            display: flex;
        }

        .decrease-button {
            margin-left: 0.25vw;
        }

        .search-container {
            margin-left: 2vw;
            background-color: rgb(115, 255, 201);
            border-radius: 10px;
            padding: 1vw;
            height: 40%;
            width: 100%;
            overflow: auto;
        }

        .introduction-text-container {
            border: 3px solid rgb(115, 255, 201);
            border-radius: 10px;
            padding: 0.5vw;
            width: 10vw;
            height: 5vw;
            overflow: auto;
        }

        .home-link-container {
            padding: 0.5vw;
        }

        #bg-mask {
            position: absolute;
            margin: auto;
            z-index: 0;
            visibility: hidden;
        }

        #popup-box {
            position: absolute;
            margin: auto;
            padding: 30px;
            width: 20vw;
            height: 6vw;
            background-color: aliceblue;
            visibility: hidden;
            border: 3px solid rgb(111, 161, 233);
            border-radius: 10px;
            z-index: 1;
        }

        .send-message-container {
            margin-top: 1vw;
            border: 3px solid rgb(115, 255, 201);
            border-radius: 10px;
            height: 2vw;
            padding: 5px;
        }

        .link-messages-button {
            width: 100%;
            height: 100%;
        }
        
    </style>
    
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for msg in messages %}
                <p><strong>{{msg}}</strong></p>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="main-container">
        <div class="left-container">
            <div class="title-container">
                <div class="title-container-inner">
                    {% if is_owner %}
                        <h1>My portfolio</h1>
                    {% endif %}
                    {% if not is_owner %}
                        <h1>{{user}}'s portfolio</h1>
                    {% endif %}
                </div>
            </div>
            {% if not is_owner %}
                <div class="home-link-container">
                    <div class="link-container-inner">
                        <a href="{{ url_for('portfolio') }}">
                            <button class="home-button"><img src="{{ url_for('static', filename='images/icons/home.png') }}" alt="home"></button>
                        </a>
                    </div>
                </div>
            {% endif %}
            <div class="introduction-container">
                {% if is_owner %}
                    <p>
                        This is your programming portfolio. Start by adding a profile photo of your self.
                    </p>
                {% endif %}
                {% if not is_owner %}
                    <br>
                {% endif %}
                <div class="profile-picture-container">
                    <div class="profile-picture-outer">
                        <div class="picture-inner">
                            {% if has_profile_pic %}
                                <img src="{{ url_for('static', filename='images/user_pic' + profile_pic_id + '.png') }}" alt="profile picture" height="50" id="profile-picture">
                            {% endif %}
                            {% if not has_profile_pic %}
                                <div class="no-profile-pic">
                                    <h3>{{user}} has no profile picture</h3>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if is_owner %}
                        <div class="new-pic-container">
                            <input type="file" id="photo-file">
                            <div class="submit-container">
                                <p>
                                    <button id="submit-photo">Submit</button>
                                </p>
                            </div>
                        </div>
                    {% endif %}
                    {% if not is_owner %}
                        <div class="send-message-container">
                            <a href="{{ url_for('messages', other_user=username) }}"><button class="link-messages-button">Send a message</button></a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="user-content">
                <div id="popup-box">
                    <div id="bg-mask">
                        <div id="popup-content">
                        </div>
                        <div id="close-button-container">
                            <button onclick="popup.hide()">Ok</button>
                        </div>
                    </div>
                </div>
                <div class="header">
                    <div class="subtitle-container">
                        {% if is_owner %}
                            <h2>Write a bit about yourself</h2>
                        {% endif %}
                        {% if not is_owner %}
                            <h2>About {{user}}</h2>
                        {% endif %}
                    </div>
                    {% if is_owner %}
                        <div class="description">
                            <p>Here you can introduce yourself, so that other people that go to your profile get to know you better.</p>
                        </div>
                    {% endif %}
                </div>
                <div class="about-container">
                    <div class="introduction-text-box-container">
                        {% if is_owner %}
                            <textarea id="intro-text-box" cols="30" rows="5" placeholder="Tell us about yourself..."></textarea>
                            <div class="submit-container">
                                <div class="save-button">
                                    <button id="save-introduction">Save</button>
                                </div>
                            </div>
                        {% endif %}
                        {% if not is_owner %}
                            <div class="introduction-text-container">
                                <p>{{intro}}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="merits">
                    <div class="description">
                        <div class="subtitle-container">
                            {% if is_owner %}
                                <h2>Your merits</h2>
                            {% endif %}
                            {% if not is_owner %}
                                <h2>{{user}}'s Merits</h2>
                            {% endif %}
                        </div>
                        <div style="margin-left: 0.5vw;">
                            {% if is_owner %}
                                <p>
                                    Add different programming skills that you possess and at what level
                                </p>
                            {% endif %}
                            {% if not is_owner %}
                                <p>
                                    {{user}}'s programming skills and merits
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="main-merits-container">
                        <div class="merits-container">
                            <div class="user-merits">
                                {% for topic in topics %}
                                    <div class="merit-container-outer" id="{{topic[0]}}">
                                        {% if is_owner %}
                                            <div class="delete-button-container">
                                                <button class="delete-button" onclick="delete_merit('{{topic[0]}}')">
                                                    <img src="{{ url_for('static', filename='images/icons/delete.png') }}" alt="delete">
                                                </button>
                                            </div>
                                        {% endif %}
                                        <div class="merit-container">
                                            <div class="topic-name-container"><p>{{topic[0]}}</p></div>
                                            <div class="level-container">
                                                <p>{{topic[1]}}</p>
                                                {% if is_owner %}
                                                    <div class="change-level-container">
                                                        <div class="improve-level">
                                                            <button class="improve-button" onclick="change_level(1, '{{topic[0]}}', '{{topic[1]}}')">▲</button>
                                                        </div>
                                                        <div class="decrease-level">
                                                            <button class="decrease-button" onclick="change_level(-1, '{{topic[0]}}', '{{topic[1]}}')">▼</button>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <br>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if is_owner %}
                                <div class="new-merit-container">
                                    <input type="text" id="new-merit" placeholder="Search...">
                                </div>
                            {% endif %}
                        </div>
                        {% if is_owner %}
                            <div id="merits-auto-complete"></div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="search-container">
                <div class="description">
                    <p>Search for other users with their username</p>
                </div>
                <div class="main-search-container">
                    <div class="search-box-container">
                        <input type="text" id="search-user" placeholder="Search...">
                    </div>
                    <div id="users-auto-complete"></div>
                </div>
            </div>
        </div>
    </div>

    <script>

        String.prototype.format = function() {
            a = this;
            for (k in arguments) {
                a = a.replace("{" + k + "}", arguments[k]);
            }
            return a;
        }

        class PopupBox {
            constructor(content=null) {
                this.content = content
            }
            config(content) {
                this.content = content
            }

            show() {
                document.getElementById("bg-mask").style.visibility = "visible";
                document.getElementById("popup-box").style.visibility = "visible";
                $("#popup-content").html("");
                let newInnerHTML = $("#popup-content").html();
                newInnerHTML += "<p>{0}</p>".format(this.content);
                $("#popup-content").html(newInnerHTML);
            }

            hide() {
                document.getElementById("bg-mask").style.visibility = "hidden";
                document.getElementById("popup-box").style.visibility = "hidden";
            }
        }

        let popup = new PopupBox();

        var socket;
        let array = ['AWS', 'AngularJS', 'Back-end programming', 'C', 'C#', 'C++', 'CSS', 'Django', 'Firebase', 'Flask', 'Front-end programming', 'Game Development', 'GoLang', 'HTML', 'Java', 'JavaScript', 'Kotlin', 'MongoDB', 'MySQL', 'Node.js', 'PHP', 'Perl', 'PostgreSQL', 'PowerShell', 'Python', 'Python 2', 'Python 3', 'R', 'React', 'Ruby', 'Rust', 'SQL', 'Scala', 'Swift', 'Unity', 'Unreal Engine', 'jQuery'];

        $(document).ready(function() {
            const introduction = "{{intro}}";
            $("#intro-text-box").val(introduction);

            socket = io.connect("/");

            socket.on("reload", function() {
                location.reload();
            })

            socket.on("delete_merit_response", function(msg) {
                $("#{0}".format(msg["topic"])).remove();
            })

            socket.on("non_valid_file", function() {
                popup.config("This image file is not valid. It has to have one of the following extenstions: .jpg, .png, .jpeg, .gif");
                popup.show();
            })

            socket.on("search_response", function(msg) {
                const results = msg["results"];
                const auto_complete_div = $("#users-auto-complete");
                auto_complete_div.html("");
                let newInnerHTML = auto_complete_div.html();
                // create table
                newInnerHTML += "<table><tr><th>First name</th><th>Last name</th><th>Username</th></tr>";

                for (const element in results) {
                    newInnerHTML += "<tr><td>{0}</td><td>{1}</td><td><a href='/portfolio/{2}'>{3}</a></td></tr>".format(results[element][0], results[element][1], results[element][2], results[element][2]);
                }
                newInnerHTML += "</table>";
                auto_complete_div.html(newInnerHTML);
            })

            $("#submit-photo").click(function() {
                const selected = document.getElementById("photo-file").files[0];
                socket.emit("select_profile_pic", {
                    img: selected,
                    name: selected.name
                });
            })

            $("#save-introduction").click(function() {
                const val = $("#intro-text-box").val();
                socket.emit("save_user_introduction", {
                    content: val
                });
            })
            let input = $("#new-merit");
            let user_search = $("#search-user");
            const auto_complete_div = $("#merits-auto-complete");

            user_search.bind("keyup", function(event) {
                if (event.keyCode === 13) {
                    socket.emit("user_search", {
                        user: user_search.val()
                    });
                }
            })

            input.bind("keyup", function(event) {
                let newInnerHTML = "";
                if (input.val().length != 0) {
                
                    let relevantOptions = auto_complete(array, input.val());
                    for (const element in relevantOptions) {
                        const option = relevantOptions[element];
                        newInnerHTML += "<div class='option'><div class='option-name'><p>{0}</p></div>".format(option);
                        newInnerHTML += "<div class='add-button-container'><button class='add-button' onclick='click_topic({0})'>Add</button></div>".format(array.indexOf(option));
                        newInnerHTML += "</div>";
                    }
                    auto_complete_div.html(newInnerHTML);
                } else {
                    for (const element in array) {
                        const option = array[element];
                        newInnerHTML += "<div class='option'><div class='option-name'><p>{0}</p></div>".format(option);
                        newInnerHTML += "<div class='add-button-container'><button class='add-button' onclick='click_topic({0})'>Add</button></div>".format(array.indexOf(option));
                        newInnerHTML += "</div>";
                    }
                    auto_complete_div.html(newInnerHTML);
                }
            })

            input.mousedown(function() {
                if (input.val().length == 0) {
                    auto_complete_div.html("");
                    let newInnerHTML = "";
                    for (const element in array) {
                        const option = array[element];
                        newInnerHTML += "<div class='option'><div class='option-name'><p>{0}</p></div>".format(option);
                        newInnerHTML += "<div class='add-button-container'><button class='add-button' onclick='click_topic({0})'>Add</button></div>".format(array.indexOf(option));
                        newInnerHTML += "</div>";
                    }
                    auto_complete_div.html(newInnerHTML);
                }
            })
        })

        function auto_complete(options, value) {
            let relevant = [];
            for (const element in options) {
                if (options[element].toLowerCase() == value.toLowerCase() || options[element].toLowerCase().includes(value.toLowerCase())) {
                    relevant.push(options[element]);
                }
            }
            return relevant;
        }

        function click_topic(index) {
            const topic = array[index];
            socket.emit("new_topic", {
                data: topic
            });
        }

        function change_level(type, topic, current) {
            // type --> improve or decrease.
            // -1 --> decrease, 1 --> improve
            socket.emit("change_level", {
                type: type,
                topic: topic,
                current: current
            });
        }

        function delete_merit(topic) {
            socket.emit("delete_merit", {
                topic: topic
            });
        }

    </script>
    
{% endblock %}
